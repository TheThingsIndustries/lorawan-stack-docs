<!DOCTYPE html>

<html class="has-navbar-fixed-top">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="generator" content="Hugo 0.140.0-DEV">
  <title>Implementation Guide | The Things Stack for LoRaWAN</title><link rel="canonical" href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/lora-basics-station/implementation-guide/" />
  <link rel="alternate icon" type="image/png" href="/docs/favicon.png">
  <link rel="icon" type="image/svg+xml" href="/docs/favicon.svg">
  <link rel="stylesheet" href="https://www.thethingsindustries.com/docs/css/theme.min.d3f3815ed6609abc2ba6d0d6e3be8af6f52947117280c3cf9fbd8f5ff6ffb058.css" integrity="sha256-0/OBXtZgmrwrptDW476K9vUpRxFygMPPn72PX/b/sFg=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta itemprop="name" content="Implementation Guide">
  <meta itemprop="description" content="">
  <meta itemprop="keywords" content="">
  <meta property="og:title" content="Implementation Guide">
  <meta property="og:description" content="">
  <meta property="og:url" content="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/lora-basics-station/implementation-guide/">
  <meta property="og:image" content="/docs/docs-thumbnail.png"/>
  <meta name="twitter:title" content="Implementation Guide" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:card" content="summary" />
  
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NGRDCNM');</script>



  <link rel="stylesheet" href="https://ttui.thethingsindustries.com/release/1.10.1/main.css" />
</head>


<body class="theme-tts">


<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NGRDCNM"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
  <div class="container is-fluid">
    <div class="navbar-brand">
      <a class="navbar-item" href="/docs/">
        <img class="logo" src="/docs/img/TTS-logo.svg">
      </a><div class="navbar-item navbar-search-menu" id="search-input-menu">
          </div>
      <span class="navbar-burger burger" data-target="topMenu">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </div>
    <div id="topMenu" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item" href="/docs/getting-started/">Getting Started</a>
        <a class="navbar-item" href="/docs/concepts/">Concepts</a>
        <a class="navbar-item" href="/docs/cloud/">The Things Stack Cloud</a>
        <a class="navbar-item" href="/docs/enterprise/">The Things Stack Enterprise</a>
        <a class="navbar-item" href="/docs/integrations/">Integrations</a>
        <a class="navbar-item" href="/docs/api/">API</a>
        <a class="navbar-item" href="/docs/hardware/">Hardware</a>

      </div>
      <div class="navbar-end"><div class="navbar-item">
            <a class="button is-primary" href="https://www.thethingsindustries.com/stack/plans/" target="_blank">Get The Things Stack</a>
          </div>
      </div>
    </div>
  </div>
</nav><script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
  <script type="text/javascript">
    docsearch({
      appId: "608OILUBK2",
      apiKey: "39082cdce449b93b2aa806b44f6af4d2",
      indexName: "thethingsstack",
      container: '#search-input-menu',
      debug: false, 
    });
  </script><div class="container" role="document">
  <div class="columns my-0 ">
      
      <div class="column is-3 is-2-desktop sidebar-left">
        

<nav class="side-navigation" aria-label="Main navigation">

<h2 class="title is-size-5">Hardware</h2>

<ul class="menu-list">
<a href="https://www.thethingsindustries.com/docs/hardware/" class="">Overview</a>
<li>
    <a href="https://www.thethingsindustries.com/docs/hardware/devices/" class="">Devices</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/" class="">Gateways</a>
    


<ul class="menu-list">

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/" class="">Concepts</a>
    
    


<ul class="menu-list">

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/adding-gateways/" class="">Adding Gateways</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/lora-basics-station/" class="">LoRa Basics™ Station</a>
    
    


<ul class="menu-list">

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/lora-basics-station/cups/" class="">Configuration and Update Server (CUPS)</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/lora-basics-station/lns/" class="">LoRaWAN Network Server (LNS)</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/lora-basics-station/cups-forwarding/" class="">Using CUPS to redirect to a different LNS</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/lora-basics-station/implementation-guide/" class="is-active">Implementation Guide</a>
    
    



    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/lora-basics-station/mtls-authentication/" class="">mTLS Authentication</a>
    
  </li>

</ul>


    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/udp/" class="">Semtech UDP Packet Forwarder</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/ttigw/" class="">The Things Industries Gateway Protocol</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/packet-forwarder/" class="">Packet Forwarders</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/gateway-rtt/" class="">Gateway Round Trip Times</a>
    
  </li>

</ul>


    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/models/" class="">Models</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/hardware/gateways/troubleshooting/" class="">Troubleshooting Gateways</a>
    
  </li>

</ul>


    
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/hardware/works-with/" class="">Works with The Things Stack</a>
  </li>
</ul>



</nav>








      </div>
      
      <div class="column is-9 is-8-desktop sidebar-middle">
        <div class="docs-content">
          
          
        <h1 class="title is-size-2">Implementation Guide</h1>
        <div class="content">
          <p>This guide contains implementation details primarily for gateway manufacturers intending to implement the LoRa Basics™ Station protocol.</p>
<div class="notification is-info is-light has-text-dark">
  <h5 class="title is-family-sans-serif has-text-dark mb-1">Note:</h5>
  The standard implementation of the LoRa Basics™ Station protocol found at the <a href="https://github.com/lorabasics/basicstation">Github page</a> is already compatible with the behaviour mentioned in this guide. Custom implementations must be aware of the following items and must ensure that these are accounted for.
</div>

<h2 id="downlink-scheduling">Downlink Scheduling</h2>
<p>The Gateway Server component of The Things Stack contains a native downlink scheduler, that optimizes downlink capacity of gateways. Implementations of the LoRa Basics™ Station also contain a scheduler.
The Things Stack prefers its own scheduler over the LoRa Basics™ Station scheduler for the following reasons:</p>
<ul>
<li>Only the The Things Stack has knowledge of all the possible downlink paths to a device via multiple gateways. An individual gateway has no knowledge of other gateways. If downlinks fail on a particular gateway, then the server will retry via a different gateway.</li>
<li>Only the The Things Stack can effectively enforce duty cycling and make sure that gateways operate within regional limits. This prevents operators from manipulating gateways to circumvent regulations.</li>
</ul>
<p>The Things Stack enforces the use of its scheduler over the LoRa Basics™ Station scheduler by manipulating the downlink parameters.</p>
<h4 id="xtime">XTime</h4>
<p>LoRa Basics™ Station uses the <a href="https://doc.sm.tc/station/tcproto.html#single-frame-downlink"><code>xtime</code></a> value to calculate the time a downlink is put on air. According to the LoRa Basics™ Station specification, the <code>xtime</code> value has to be echoed unchanged by the server to the gateway. However, The Things Stack deviates from this expectation by manipulating the <code>xtime</code> to force the gateway to schedule downlinks based on the server&rsquo;s scheduler instead of the gateway scheduler.</p>
<p>The <code>xtime</code> parameter is encoded as follows. The Things Stack only manipulates bits <code>47-0</code>, based on an internal clock that is maintained for each gateway. The rest of the upper bits are returned as-is.</p>
<div class="fixed-table table-lbs-xtime">
<table>
  <thead>
      <tr>
          <th>Bit(s)</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>63</td>
          <td>Sign (always positive)</td>
      </tr>
      <tr>
          <td>62-56</td>
          <td>Radio unit where the time stamp originated from (max 128)</td>
      </tr>
      <tr>
          <td>55-48</td>
          <td>Session ID; Random value to disambiguate different SX1301 sessions (should never be 0).</td>
      </tr>
      <tr>
          <td>47-0</td>
          <td>Microseconds since SX1301 start (rollover every 9y &raquo; uptime of sessions).</td>
      </tr>
  </tbody>
</table>
</div>
<br>
<p>Custom implementations of LoRa Basics™ Station working with The Things Stack must ensure that the <code>Session ID</code> bits (55-48) are never zero and take into account the fact that the bits 47-0 are modified.</p>
<h4 id="downlink-windows">Downlink Windows</h4>
<p>LoRa Basics™ Station allows the server to provide both the RX1 and RX2 parameters of the downlink message, <a href="https://doc.sm.tc/station/tcproto.html#single-frame-downlink"><code>dnmsg</code></a>. This is so that the gateway can retry downlinks in RX2, if it failed in RX1. The Things Stack however only sets the RX1 values (<code>RX1DR</code> and <code>RX1Freq</code>), thereby forcing the gateway to schedule only once. Errors in scheduling and subsequent retries are handled in The Things Stack and not on the gateway. If The Things Stack wants to force the gateway to schedule in the RX2 window, it sends the RX2 parameters in the same RX1 fields of the <code>dnmsg</code> but offsets the downlink time (<code>xtime</code>) to make the gateway schedule in the correct window.</p>
<p>Custom implementations of LoRa Basics™ Station working with The Things Stack only need to schedule downlink messages that are sent by the The Things Stack and let the latter handle retries and conflicts.</p>
<h2 id="use-of-deveui-field-in-downlink-messages">Use of DevEui field in Downlink Messages</h2>
<p>Gateways using the LoRa Basics™ Station protocol report the successful transmission of downlink messages via the Transmit Confirmation (<code>dntxed</code>) message. In order to correlate the confirmation message to a downlink, the LoRa Basics™ Station protocol provides two options to the LNS. The LNS is offered the flexibility to implement either of these mechanisms.</p>
<p>a. Using the <code>DevEui</code> and the <code>diid</code> fields</p>
<ul>
<li>In this mode, the LNS uses a per-device downlink counter. Gateways echo the <code>DevEui</code> and <code>diid</code> fields sent on the downlink message on the corresponding Transmit Confirmation message.</li>
<li>The LNS then forwards the transmit confirmation upstream.</li>
<li>This is useful for debugging using LoRa Basics™ Station gateway logs since the <code>DevEui</code> will be printed. However, this exposes the DevEui of end devices to gateways which is not desirable in cases where the gateway is not owned/operated by the device owner.</li>
<li>The Things Stack does not use this method to correlate Transmit Confirmations.</li>
</ul>
<p>b. Using only the <code>diid</code> field</p>
<ul>
<li>The LNS can choose to make the <code>diid</code> field globally unique per gateway (per session). The LNS can then maintain a correlation of the <code>diid</code> values to downlink messages.</li>
<li>When the gateway sends a Transmit Confirmation message, the LNS can then use the echoed <code>diid</code> value to look up the downlink message and retrieve information on the end device and forward the transmit confirmation upstream.</li>
<li>In this mode, the <code>DevEui</code> field of the downlink message is not used by the LNS but should be set to a non-zero value.</li>
<li>This is the approach used by The Things Stack, where the <code>DevEui</code> is set to <code>0000000000000001</code> for all downlink messages.</li>
</ul>
        </div>
        <div class="is-clearfix">
<a class="button is-pulled-left" href="/docs/hardware/gateways/concepts/lora-basics-station/cups-forwarding/">← Using CUPS to redirect to a different LNS</a>
<a class="button is-pulled-right" href="/docs/hardware/gateways/concepts/lora-basics-station/mtls-authentication/">mTLS Authentication →</a>
</div>

        <script>window.emojicom_widget = { campaign: "NEDHszRC2r2KaGj1mhj7" };</script>
<script src="https://cdn.emojicom.io/embed/widget.js" async></script>

<div class='feedback has-vertical-space'>
  <div id="emojicom-widget-inline"></div>
</div>
        </div>
      </div>
      
      <div class="column is-hidden-touch is-2-desktop sidebar-right">
        <nav class="toc" aria-label="Page navigation">
    <h2 class="title is-size-6">On this page</h2>
    


  <ul class="menu-list">
    
      
      <li><a href='#downlink-scheduling'>Downlink Scheduling</a></li>
    
      
      <li><a href='#use-of-deveui-field-in-downlink-messages'>Use of DevEui field in Downlink Messages</a></li>
    
  </ul>


  </nav>

      </div>
      
  </div>
</div>



<footer class="footer">
  <div class="container">
    <div class="columns">
      <nav class="column is-one-fourth">
        <h3 class="title is-6">Sections</h3>
        <p><a class="" href="/docs/getting-started/">Getting Started</a></p>
        <p><a class="" href="/docs/concepts/">Concepts</a></p>
        <p><a class="" href="/docs/cloud/">The Things Stack Cloud</a></p>
        <p><a class="" href="/docs/enterprise/">The Things Stack Enterprise</a></p>
        <p><a class="" href="/docs/integrations/">Integrations</a></p>
        <p><a class="" href="/docs/api/">API</a></p>
        <p><a class="" href="/docs/hardware/">Hardware</a></p>
      </nav>
      <nav class="column is-one-fourth">
        <h3 class="title is-6">Sitemap</h3>
        <p><a class="" href="https://www.thethingsindustries.com/docs/sitemap/">View our Sitemap</a></p>
      </nav>
      <nav class="column is-one-fourth">
        <h3 class="title is-6">Contributing</h3>
        <p><a class="" href="https://github.com/TheThingsIndustries/lorawan-stack-docs">GitHub</a></p>
      </nav>
      
      <nav class="column is-one-fourth">
        <h3 class="title is-6">About Us</h3>
        <p><a class="" href="https://www.thethingsindustries.com">The Things Industries</a></p>
      </nav>
      </div>
  </div>
</footer>
<script src="https://www.thethingsindustries.com/docs/js/vendor/basicLightbox.min.js"></script>
<script src="https://www.thethingsindustries.com/docs/js/theme.min.3bf0da17f5ab4cc0f916662c2d2f977f7fa7259b4483f7f9eb46e875a556cc43.js" integrity="sha256-O/DaF/WrTMD5FmYsLS&#43;Xf3&#43;nJZtEg/f560bodaVWzEM=" crossorigin="anonymous"></script><script>
  window.intercomSettings = {
    app_id: "pp8esr7h",
  };
</script>

<script>
(function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/pp8esr7h';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
</script>

</body>

</html>
