<!DOCTYPE html>

<html class="has-navbar-fixed-top">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="generator" content="Hugo 0.70.0" />
  <title>Architecture | The Things Stack for LoRaWAN</title><link rel="canonical" href="https://thethingsstack.io/getting-started/aws/ecs/architecture/" />
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="alternate icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="https://thethingsstack.io/css/theme.min.cfc828cf25058c21e931fe626d67f57f507e9b4dd2a9b3628bde644419747477.css" integrity="sha256-z8gozyUFjCHpMf5ibWf1f1B&#43;m03SqbNii95kRBl0dHc="><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta itemprop="name" content="Architecture">
  <meta itemprop="description" content="">
  <meta itemprop="keywords" content="">
  <meta property="og:title" content="Architecture">
  <meta property="og:description" content="">
  <meta property="og:url" content="https://thethingsstack.io/getting-started/aws/ecs/architecture/">
  <meta name="twitter:title" content="Architecture" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:card" content="summary" />
</head>


<body>

<nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img class="logo" src="/img/TTS-logo.svg">
        <p class="navbar-item is-size-7">v3.10</p>
      </a>
      <span class="navbar-burger burger" data-target="topMenu">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </div>
    <div id="topMenu" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item" href="/getting-started/">Getting Started</a>
        <a class="navbar-item" href="/devices/">Devices</a>
        <a class="navbar-item" href="/gateways/">Gateways</a>
        <a class="navbar-item" href="/integrations/">Integrations</a>
        <a class="navbar-item" href="/reference/">Reference</a>
      </div>
      <div class="navbar-end"><div class="navbar-item">
            <a class="button is-primary" href="/download/">Get The Things Stack</a>
          </div>
      </div>
    </div>
  </div>
</nav>
<section class="search-container">
    <div class="container">
      <div class="columns is-vcentered">
        <div class="column">
          <div class="field has-addons has-addons-centered">
            <div class="control">
              <input class="input search-bar" id="search-input" type="text" placeholder="Search" type="text">
            </div>
          </div>
        </div>
      </div>
    </div>
</section>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
apiKey: "4372282a02970d8402d43457bf95d486",
indexName: "thethingsstack",
inputSelector: '#search-input',
debug: false 
});
</script>

<main>
<section class="section">
  <div class="container">
    <div class="columns">
      
      <div class="column is-one-third">


<h2 class="title is-size-4">AWS ECS</h2>

<ul class="menu-list">
<a href="https://thethingsstack.io/getting-started/aws/ecs/" class="">Overview</a>
<li>
  <a href="https://thethingsstack.io/getting-started/aws/ecs/architecture/" class="is-active">Architecture</a>
</li>
<li>
  <a href="https://thethingsstack.io/getting-started/aws/ecs/prerequisites/" class="">Prerequisites</a>
</li>
<li>
  <a href="https://thethingsstack.io/getting-started/aws/ecs/deployment/" class="">Deployment</a>
</li>
<li>
  <a href="https://thethingsstack.io/getting-started/aws/ecs/database-operations/" class="">Database Operations</a>
</li>
<li>
  <a href="https://thethingsstack.io/getting-started/aws/ecs/monitoring/" class="">Monitoring</a>
</li>
</ul>





      </div>
      
      <div class="column is-two-thirds">

<h1 class="title is-size-2">Architecture


</h1>

<div class="content">

<p>This page describes the architecture of a The Things Stack deployment on AWS ECS.</p>
<h2 id="vpc-and-subnets">VPC and Subnets</h2>
<p>The foundation of the deployment is the Virtual Private Cloud (VPC) that lets us create an isolated environment within the AWS cloud.</p>
<p><img src="aws-vpc.svg" alt="VPC and Subnets"></p>
<p>We will deploy The Things Stack across two availability zones (AZs). In each AZ we have a private subnet that will contain the resources for The Things Stack such as databases, container instances and the application containers themselves. Since these resources can&rsquo;t communicate with the internet directly, we also have public subnets that contain a Network Load Balancer (NLB) for load balancing incoming traffic across instances and a NAT Gateway (NGW) for outgoing connections from resources in the private subnet.</p>
<p>The NLBs and NGWs all have Elastic IP address. All incoming connections to The Things Stack will use the IP addresses of the NLBs, and all outgoing connections will use the IP addresses of the NGWs. This means that you can use these IP addresses in the firewall rules for gateways that need to connect to your deployment, and on other servers that need to connect to your deployment or receive connections (webhooks) from it.</p>
<h2 id="persistence">Persistence</h2>
<p>The Things Stack relies on two databases: PostgreSQL and Redis. AWS offers these databases as managed services, so that we can focus on operating a LoRaWAN network instead of operating databases.</p>
<p>We use a PostgreSQL-compatible version of Amazon Aurora and a Redis-compatible version of Amazon ElastiCache. Both PostgreSQL and Redis are deployed in a multi-AZ master-replica setup.</p>
<p>If desired, it is possible to use separate Redis clusters for persistent storage and for caching.</p>
<p><img src="aws-databases.svg" alt="Databases"></p>
<p>User uploads of profile pictures and end device pictures are stored in S3 buckets.</p>
<blockquote>
<p><strong>Note:</strong> In multi-cluster deployments, the PostgreSQL database, the S3 bucket for profile pictures and the S3 bucket for end device pictures are only deployed in the primary cluster.</p>
</blockquote>
<h2 id="configuration">Configuration</h2>
<p>The AWS ECS deployment of The Things Stack uses a combination of configuration stored in AWS Systems Manager Parameter Store, secrets stored in AWS Secrets Manager and other environment variables that are set directly on the ECS tasks.</p>
<p>The configuration for interoperability with other LoRaWAN Backend Interfaces-compliant servers can become quite complicated and is therefore stored as multiple files in an S3 bucket.</p>
<h2 id="containers">Containers</h2>
<p>The Things Stack itself is deployed as Docker Containers on AWS ECS.</p>
<p><img src="aws-ecs.svg" alt="ECS Cluster"></p>
<p>The ECS cluster uses container instances in the private subnets of both availability zones. Each container instance runs at least a Gateway Server container that is dedicated for UDP gateways. This is necessary because of the limited support for UDP in ECS.</p>
<p>Depending on your preferences, you can run other containers on your container instances, or choose to use AWS Fargate.</p>
<h2 id="networking">Networking</h2>
<p>All internal communication between the different components of The Things Stack is done over gRPC (port 1884) and HTTP (port 1885). For incoming connections from outside the cluster, ECS registers a number of services in the NLB.</p>
<p><img src="aws-ecs-containers.svg" alt="ECS Containers"></p>
<p>In addition to containers for the different components of The Things Stack, our deployment also contains proxy containers to route HTTP and gRPC requests to the correct component. Prometheus containers are used for monitoring the deployment.</p>
<blockquote>
<p><strong>Note:</strong> In multi-cluster deployments, the Identity Server containers in secondary clusters are replaced with containers that proxy requests to Identity Server in the primary cluster.</p>
</blockquote>
</div>



<script>window.emojicom_widget = { campaign: "NEDHszRC2r2KaGj1mhj7" };</script>
<script src="https://cdn.emojicom.io/embed/widget.js" async></script>

<div class='feedback has-vertical-space'>
  <div id="emojicom-widget-inline"></div>
</div>


<div class="is-clearfix">
<a class="button is-pulled-left" href="/getting-started/aws/ecs/">← AWS ECS</a>
<a class="button is-pulled-right" href="/getting-started/aws/ecs/prerequisites/">Prerequisites →</a>
</div>




      </div>
    </div>
  </div>
</section>
</main>

<footer class="footer background-footer">
  <div class="container">
    <div class="columns">
      <nav class="column is-one-quarter">
        <h3 class="title is-6">The Things Stack</h3>
        <p><a class="" href="/getting-started/">Getting Started</a></p>
        <p><a class="" href="/devices/">Devices</a></p>
        <p><a class="" href="/gateways/">Gateways</a></p>
        <p><a class="" href="/integrations/">Integrations</a></p>
        <p><a class="" href="/reference/">Reference</a></p>
      </nav>
      <nav class="column is-one-quarter">
        <h3 class="title is-6">Contributing</h3>
        <p><a class="" href="https://github.com/TheThingsIndustries/lorawan-stack-docs">GitHub</a></p>
        <p><a class="" href="https://www.thethingsnetwork.org/forum/c/network-and-routing/v3">Forum</a></p>
      </nav>
      
      <nav class="column is-one-quarter">
        <h3 class="title is-6">About Us</h3>
        <p><a class="" href="https://www.thethingsnetwork.org">The Things Network</a></p>
        <p><a class="" href="https://www.thethingsindustries.com">The Things Industries</a></p>
      </nav>
      <div class="column is-one-quarter">
        <h3 class="title is-6">About this page</h3>
        <div class="content">
<p class="is-size-7">
  Last changed by Nejra on 20 Nov 2020.
  <br>
  <a href="https://github.com/TheThingsIndustries/lorawan-stack-docs/commit/6c87bfba72ffae8f55b136e065a03ffcbbae942c">
      doc: Improving readability of AWS doc
    </a>
</p>

<a href="https://github.com/TheThingsIndustries/lorawan-stack-docs/blob/master/doc/content/getting-started/aws/ecs/architecture/_index.md" class="button">Edit on Github</a>
</div>

      </div>
    </div>
  </div>
</footer>
<script src="https://thethingsstack.io/js/theme.min.4feb1389331adbef9047157f884dbdbd63af1c61ac83f327e60eef42f999cb26.js" integrity="sha256-T&#43;sTiTMa2&#43;&#43;QRxV/iE29vWOvHGGsg/Mn5g7vQvmZyyY="></script><script>
  window.intercomSettings = {
    app_id: "pp8esr7h",
  };
</script>

<script>
(function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/pp8esr7h';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
</script>

</body>

</html>
