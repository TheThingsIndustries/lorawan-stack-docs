<!DOCTYPE html>

<html class="has-navbar-fixed-top">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="generator" content="Hugo 0.112.3">
  <title>Updating AWS AMI Deployment | The Things Stack for LoRaWAN</title><link rel="canonical" href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ami/updating/" />
  <link rel="alternate icon" type="image/png" href="/docs/favicon.png">
  <link rel="icon" type="image/svg+xml" href="/docs/favicon.svg">
  <link rel="stylesheet" href="https://www.thethingsindustries.com/docs/css/theme.min.21413411dcb7ceb71f0089712d35a7e290a58ed727cd109f5780d2e7967c6299.css" integrity="sha256-IUE0Edy3zrcfAIlxLTWn4pCljtcnzRCfV4DS55Z8Ypk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta itemprop="name" content="Updating AWS AMI Deployment">
  <meta itemprop="description" content="">
  <meta itemprop="keywords" content="">
  <meta property="og:title" content="Updating AWS AMI Deployment">
  <meta property="og:description" content="">
  <meta property="og:url" content="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ami/updating/">
  <meta property="og:image" content="/docs/docs-thumbnail.png"/>
  <meta name="twitter:title" content="Updating AWS AMI Deployment" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:card" content="summary" />
  
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NGRDCNM');</script>



  <link rel="stylesheet" href="https://ttui.thethingsindustries.com/release/1.7.2/main.css" />
</head>


<body class="theme-tts">


<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NGRDCNM"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
  <div class="container is-fluid">
    <div class="navbar-brand">
      <a class="navbar-item" href="/docs/">
        <img class="logo" src="/docs/img/TTS-logo.svg">
      </a><div class="navbar-item navbar-search-menu" id="search-input-menu">
          </div>
      <span class="navbar-burger burger" data-target="topMenu">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </div>
    <div id="topMenu" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item" href="/docs/getting-started/">Getting Started</a>
        <a class="navbar-item" href="/docs/devices/">Devices</a>
        <a class="navbar-item" href="/docs/gateways/">Gateways</a>
        <a class="navbar-item" href="/docs/the-things-stack/">The Things Stack</a>
        <a class="navbar-item" href="/docs/integrations/">Integrations</a>
        <a class="navbar-item" href="/docs/reference/">Reference</a>

      </div>
      <div class="navbar-end"><div class="navbar-item">
            <a class="button is-primary" href="https://accounts.thethingsindustries.com/fee-calculator">Get The Things Stack</a>
          </div>
      </div>
    </div>
  </div>
</nav><script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
  <script type="text/javascript">
    docsearch({
      appId: "608OILUBK2",
      apiKey: "39082cdce449b93b2aa806b44f6af4d2",
      indexName: "thethingsstack",
      container: '#search-input-menu',
      debug: false, 
    });
  </script><div class="container" role="document">
  <div class="columns my-0 ">
      
      <div class="column is-3 is-2-desktop sidebar-left">
        

<nav class="side-navigation" aria-label="Main navigation">

<h2 class="title is-size-5">The Things Stack</h2>

<ul class="menu-list">
<a href="https://www.thethingsindustries.com/docs/the-things-stack/" class="">Overview</a>
<li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/concepts/" class="">Basic Concepts</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/cloud/" class="">The Things Stack Cloud</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/" class="">Host The Things Stack</a>
    


<ul class="menu-list">

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/" class="">AWS</a>
    
    


<ul class="menu-list">

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ami/" class="">AWS Marketplace AMI</a>
    
    


<ul class="menu-list">

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ami/deployment-guide/" class="">Deployment Guide</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ami/post-deployment/" class="">Post Deployment Configuration</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ami/updating/" class="is-active">Updating AWS AMI Deployment</a>
    
    



    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ami/best-practices/" class="">Best Practices</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ami/application-server-telemetry/" class="">Application Server Telemetry</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ami/troubleshooting/" class="">Troubleshooting AWS AMI Deployment</a>
    
  </li>

</ul>


    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ecs/" class="">AWS ECS</a>
    
  </li>

</ul>


    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/kubernetes/" class="">Kubernetes</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/docker/" class="">Docker</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/join-server/" class="">The Things Join Server</a>
    
  </li>

</ul>


    
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/interact/" class="">Interact with The Things Stack</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/management/" class="">Manage The Things Stack</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/migrating/" class="">Migrate to The Things Stack</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/packet-broker/" class="">Packet Broker</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/works-with/" class="">Works with The Things Stack</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/the-things-stack/troubleshooting/" class="">Troubleshooting</a>
  </li>
</ul>



</nav>








      </div>
      
      <div class="column is-9 is-8-desktop sidebar-middle">
        <div class="docs-content">
        <h1 class="title is-size-2">Updating AWS AMI Deployment
          
        </h1>
        
        <div class="content">
          <p>This section contains information to update The Things Stack AWS AMI deployment.</p>
<h2 id="updating-the-cloudformation-stack">Updating the CloudFormation Stack</h2>
<p>We recommend using <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-changesets.html">Change Sets</a> to update the CloudFormation Stack.</p>
<div class="notification is-warning is-light has-text-dark">
  <h5 class="title is-family-sans-serif has-text-dark mb-1">Warning:</h5>
  Updating The Things Stack AWS AMI deployment sometimes involves replacing the EC2 instance. When this is necessary, this will be indicated in Change Set before applying the change.
When the EC2 instance is replaced, the built-in ACME feature requests new Let&rsquo;s Encrypt certificates.
Let&rsquo;s Encrypt has a weekly <a href="https://letsencrypt.org/docs/rate-limits/">certificate limit</a> of 5 per domain.
In order not to hit the rate-limit, make sure that you are not making changes that replace the EC2 machine more often than the rate-limit i.e, 5 per week.
If you are using custom certificates via the provided parameters, this is not applicable.
</div>

<p>On the AWS Console, open the <strong>CloudFormation</strong> service, navigate to the <strong>Change sets</strong> tab and select <strong>Create change set</strong>. There are two choices that can be made here:</p>
<ul>
<li>Use current template: Choose this option to update input parameters on an existing template.</li>
<li>Replace current template: Choose this option to use a new template on the existing deployment. This option should be used to apply new versions of The Things Stack that are delivered as new version of the CloudFormation template.</li>
</ul>
<p>Once the necessary options are updated, select the <strong>Create Change Set</strong> option. This will create a change set that describes the resources that will be updated by this change and if any of these resources need to be replaced.</p>
<p>After confirming the changes, select <strong>Execute</strong>. Depending on the resources, this will take some time to complete and can be tracked using the <strong>Events</strong> tab on the AWS Console.</p>
<div class="notification is-info is-light has-text-dark">
  <h5 class="title is-family-sans-serif has-text-dark mb-1">Note:</h5>
  We recommend to only update the AWS resource configuration via the CloudFormation template. Updating resources outside CloudFormation causes unpredicted behavior during updates or EC2 instance restart, and limits the possible support we can provide.
</div>

<h2 id="new-cloudformation-template">New CloudFormation template</h2>
<p>New CloudFormation template version can be downloaded from <a href="https://aws.amazon.com/marketplace/pp/prodview-okhh3ofzhqj56?qid=1593444260869&amp;sr=0-1&amp;ref_=srh_res_product_title#pdp-usage">AWS Marketplace</a>. Click <strong>View CloudFormation Template</strong> and then <strong>Download CloudFormation Template</strong> to download the most recent template.</p>
<h2 id="manual-upgrade-of-databases-amazon-rds-and-elasticache-using-snapshots">Manual Upgrade of Databases (Amazon RDS and ElastiCache) using snapshots</h2>
<p>The update of certain fields of the CloudFormation stack necessitates the recreation of the database. AWS does not automatically migrate the data and hence, this must be done manually. This section applies only when CloudFormation plans to recreate the database.</p>
<p>In order to migrate the database without the loss of data, first create a snapshot of your database before running a change set on these fields.</p>
<ul>
<li>For RDS, navigate to <strong>RDS</strong> &gt; <strong>Snapshots</strong> on the AWS Console and select <strong>Take Snapshot</strong>.</li>
<li>For Redis (ElastiCache), navigate to <strong>ElastiCache</strong> on the AWS Console and select your Redis Replication Group and select <strong>Backup</strong> option.</li>
</ul>
<p>Now run a change set on CloudFormation.</p>
<ul>
<li>For RDS, enter the ARN (Amazon Resource Name) of the snapshot into the <strong>Amazon RDS Snapshot</strong> field and run the change set.</li>
<li>For Redis (ElastiCache), enter the Name of the backup into the <strong>Amazon ElastiCache Redis Snapshot</strong> and run the change set.</li>
</ul>
<h2 id="database-schema-migrations">Database Schema Migrations</h2>
<p>When updating minor version of the stack, you might be required to perform database migrations. Please refer to the changelog for information which migrations are needed when updating to given version. Remember that you need to perform migrations mentioned not only in the latest version, but also those mentioned in versions between your current and target version. Database migrations are run by logging into the EC2 machine that the stack runs on, and executing relevant commands. Required command you need to run is also mentioned in the changelog, for example:</p>
<blockquote>
<p>This requires a database schema migration (<code>ttn-lw-stack is-db migrate</code>) because of the added columns.</p>
</blockquote>
<p>The <code>tti-lw-stack</code> executable is located in <code>/tti/lorawan-stack/</code>. When running it, in the environment you need to have the <code>TTN_LW_CONFIG=/tti/lorawan-stack/config.yml</code> variable exported. Example use:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TTN_LW_CONFIG</span><span class="o">=</span>/tti/lorawan-stack/config.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">/tti/lorawan-stack/tti-lw-stack is-db migrate
</span></span></code></pre></div><p>If you encounter any issues, please refer to <a href="https://www.thethingsindustries.com/docs/the-things-stack/host/aws/ami/troubleshooting/">Troubleshooting</a>.</p>
        </div>
          <div class="columns is-multiline">
</div>

          <div class="is-clearfix">
<a class="button is-pulled-left" href="/docs/the-things-stack/host/aws/ami/post-deployment/">← Post Deployment Configuration</a>
<a class="button is-pulled-right" href="/docs/the-things-stack/host/aws/ami/best-practices/">Best Practices →</a>
</div>

          <script>window.emojicom_widget = { campaign: "NEDHszRC2r2KaGj1mhj7" };</script>
<script src="https://cdn.emojicom.io/embed/widget.js" async></script>

<div class='feedback has-vertical-space'>
  <div id="emojicom-widget-inline"></div>
</div>
        </div>
      </div>
      
      <div class="column is-hidden-touch is-2-desktop sidebar-right">
        <nav class="toc" aria-label="Page navigation">
    <h2 class="title is-size-6">On this page</h2>
    


  <ul class="menu-list">
    
      
      <li><a href='#updating-the-cloudformation-stack'>Updating the CloudFormation Stack</a></li>
    
      
      <li><a href='#new-cloudformation-template'>New CloudFormation template</a></li>
    
      
      <li><a href='#manual-upgrade-of-databases-amazon-rds-and-elasticache-using-snapshots'>Manual Upgrade of Databases (Amazon RDS and ElastiCache) using snapshots</a></li>
    
      
      <li><a href='#database-schema-migrations'>Database Schema Migrations</a></li>
    
  </ul>


  </nav>

      </div>
      
  </div>
</div>



<footer class="footer">
  <div class="container">
    <div class="columns">
      <nav class="column is-one-third">
        <h3 class="title is-6">The Things Stack</h3>
        <p><a class="" href="/docs/getting-started/">Getting Started</a></p>
        <p><a class="" href="/docs/devices/">Devices</a></p>
        <p><a class="" href="/docs/gateways/">Gateways</a></p>
        <p><a class="" href="/docs/the-things-stack/">The Things Stack</a></p>
        <p><a class="" href="/docs/integrations/">Integrations</a></p>
        <p><a class="" href="/docs/reference/">Reference</a></p>
      </nav>
      <nav class="column is-one-third">
        <h3 class="title is-6">Contributing</h3>
        <p><a class="" href="https://github.com/TheThingsIndustries/lorawan-stack-docs">GitHub</a></p>
      </nav>
      
      <nav class="column is-one-third">
        <h3 class="title is-6">About Us</h3>
        <p><a class="" href="https://www.thethingsindustries.com">The Things Industries</a></p>
      </nav>
      </div>
  </div>
</footer>
<script src="https://www.thethingsindustries.com/docs/js/vendor/basicLightbox.min.js"></script>
<script src="https://www.thethingsindustries.com/docs/js/theme.min.4a22f0dea0620048bc258cf6dedbdfbec40f3b5dba1dcdc6536e61e7bc20a5bf.js" integrity="sha256-SiLw3qBiAEi8JYz23tvfvsQPO126Hc3GU25h57wgpb8=" crossorigin="anonymous"></script><script>
  window.intercomSettings = {
    app_id: "pp8esr7h",
  };
</script>

<script>
(function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/pp8esr7h';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
</script>

</body>

</html>
