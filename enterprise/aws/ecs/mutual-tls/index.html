<!DOCTYPE html>

<html class="has-navbar-fixed-top">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="generator" content="Hugo 0.134.2">
  <title>Mutual TLS | The Things Stack for LoRaWAN</title><link rel="canonical" href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/mutual-tls/" />
  <link rel="alternate icon" type="image/png" href="/docs/favicon.png">
  <link rel="icon" type="image/svg+xml" href="/docs/favicon.svg">
  <link rel="stylesheet" href="https://www.thethingsindustries.com/docs/css/theme.min.d3f3815ed6609abc2ba6d0d6e3be8af6f52947117280c3cf9fbd8f5ff6ffb058.css" integrity="sha256-0/OBXtZgmrwrptDW476K9vUpRxFygMPPn72PX/b/sFg=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
  <meta name="description" content="Mutual TLS authentication">
  <meta name="keywords" content="">
  <meta itemprop="name" content="Mutual TLS">
  <meta itemprop="description" content="Mutual TLS authentication">
  <meta itemprop="keywords" content="">
  <meta property="og:title" content="Mutual TLS">
  <meta property="og:description" content="Mutual TLS authentication">
  <meta property="og:url" content="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/mutual-tls/">
  <meta property="og:image" content="/docs/docs-thumbnail.png"/>
  <meta name="twitter:title" content="Mutual TLS" />
  <meta name="twitter:description" content="Mutual TLS authentication" />
  <meta name="twitter:card" content="summary" />
  
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NGRDCNM');</script>



  <link rel="stylesheet" href="https://ttui.thethingsindustries.com/release/1.10.1/main.css" />
</head>


<body class="theme-tts">


<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NGRDCNM"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
  <div class="container is-fluid">
    <div class="navbar-brand">
      <a class="navbar-item" href="/docs/">
        <img class="logo" src="/docs/img/TTS-logo.svg">
      </a><div class="navbar-item navbar-search-menu" id="search-input-menu">
          </div>
      <span class="navbar-burger burger" data-target="topMenu">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </div>
    <div id="topMenu" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item" href="/docs/getting-started/">Getting Started</a>
        <a class="navbar-item" href="/docs/concepts/">Concepts</a>
        <a class="navbar-item" href="/docs/cloud/">The Things Stack Cloud</a>
        <a class="navbar-item" href="/docs/enterprise/">The Things Stack Enterprise</a>
        <a class="navbar-item" href="/docs/integrations/">Integrations</a>
        <a class="navbar-item" href="/docs/api/">API</a>
        <a class="navbar-item" href="/docs/hardware/">Hardware</a>

      </div>
      <div class="navbar-end"><div class="navbar-item">
            <a class="button is-primary" href="https://www.thethingsindustries.com/stack/plans/" target="_blank">Get The Things Stack</a>
          </div>
      </div>
    </div>
  </div>
</nav><script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
  <script type="text/javascript">
    docsearch({
      appId: "608OILUBK2",
      apiKey: "39082cdce449b93b2aa806b44f6af4d2",
      indexName: "thethingsstack",
      container: '#search-input-menu',
      debug: false, 
    });
  </script><div class="container" role="document">
  <div class="columns my-0 ">
      
      <div class="column is-3 is-2-desktop sidebar-left">
        

<nav class="side-navigation" aria-label="Main navigation">

<h2 class="title is-size-5">The Things Stack Enterprise</h2>

<ul class="menu-list">
<a href="https://www.thethingsindustries.com/docs/enterprise/" class="">Overview</a>
<li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/" class="">AWS</a>
    


<ul class="menu-list">

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ami/" class="">AWS Marketplace AMI</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/" class="">AWS ECS</a>
    
    


<ul class="menu-list">

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/architecture/" class="">Architecture</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/prerequisites/" class="">Prerequisites</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/deployment/" class="">Deployment</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/database-operations/" class="">Database Operations</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/monitoring/" class="">Monitoring</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/updating/" class="">Updating</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/best-practices/" class="">Best Practices</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/interop/" class="">Interoperability</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/mutual-tls/" class="is-active">Mutual TLS</a>
    
    



    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/troubleshooting/" class="">Troubleshooting AWS ECS Deployment</a>
    
  </li>

  <li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/changelog/" class="">Template Changelog</a>
    
  </li>

</ul>


    
  </li>

</ul>


    
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/kubernetes/" class="">Kubernetes</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/docker/" class="">Docker</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/join-server/" class="">The Things Join Server</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/enterprise/management/" class="">Manage The Things Stack</a>
  </li>
</ul>



</nav>








      </div>
      
      <div class="column is-9 is-8-desktop sidebar-middle">
        <div class="docs-content">
        
        
          <div class="content-tags">
            
            
              <span class="tag is-light">New in 3.30.0</span>

            
            
            
          </div>
        
        <h1 class="title is-size-2">Mutual TLS</h1>
        <div class="content">
          <p>The Things Stack supports mutual TLS authentication via a supported proxy (Envoy and Traefik).</p>
<h2 id="mechanism">Mechanism</h2>
<p>The Things Stack does not terminate mTLS connections: this is done by the proxy. The proxy is expected to forward the presented TLS client certificate via an HTTP header to The Things Stack.</p>
<p>The Things Stack verifies this header with a pre-configured list of CAs.</p>
<p>The Things Stack supports mTLS authentication for LoRa Basics™ Station CUPS connections.</p>
<h3 id="tls-termination">TLS termination</h3>
<p>In the standard deployment model, AWS Network Load Balancer (NLB) terminates TLS, and then forwards unencrypted packets to The Things Stack via AWS internal network.</p>
<p>Since the NLB does not support verifying client TLS certificates, the proxy performs TLS termination, only on the relevant ports. This includes <strong>8987</strong> (LoRa Basics™ Station CUPS mTLS) port.</p>
<h3 id="certificate-requirements">Certificate Requirements</h3>
<p>The <code>CN</code> (Common Name) field of the certificate must be the 16 digit gateway EUI. Example: <code>0123456789ABCDEF</code></p>
<h2 id="update-instructions">Update Instructions</h2>
<p>The <code>SupportProxyTLS</code> and <code>LBSCUPSmTLSEnabled</code> options are available in multiple templates. Make sure to set it to <code>true</code> in <strong>all</strong> the templates if the proxy should terminate LoRa Basics™ Station CUPS mTLS Connections.</p>
<p>If not, it should be set to <code>false</code> in <strong>all</strong> the templates (this is the default). Setting it <code>true</code> in one and <code>false</code> in another will lead to to errors.</p>
<h3 id="preparation">Preparation</h3>
<ul>
<li>If you are deploying TTS for the first time, complete the steps with <code>SupportProxyTLS</code> and <code>LBSCUPSmTLSEnabled</code> set to <code>false</code> (this is the default).</li>
<li>If you are updating to a version with <code>mTLS</code> support from a previous version, first deploy the following templates in this exact order with <code>SupportProxyTLS</code> and <code>LBSCUPSmTLSEnabled</code> set to <code>false</code>.
<ul>
<li><code>3-1-security-group-rules</code>: The template will be deployed with no changes.</li>
<li><code>3-2-load-balancer-rules</code>: The template will be deployed with no changes.</li>
<li><code>4-1-secrets</code>: The template will be deployed with no changes.</li>
<li><code>4-2a-configuration</code>: CloudFormation will mark <code>GSConfiguration</code> for a change but this is only on the template. No resources will be changed.</li>
<li><code>5-4-ecs-services</code>: There will be changes to the GS and GCS Task roles. The GS/GCS services/tasks will not be updated.</li>
<li><code>5-7-ecs-proxy</code>: The template will be deployed with no changes.</li>
<li><code>5-8a-certs-le</code>: The template will be deployed with no changes.</li>
</ul>
</li>
</ul>
<h3 id="enabling-mtls-support">Enabling mTLS Support</h3>
<p>Once the preparation step is complete, run the following steps in the <em>exact same order</em> as described here.</p>
<h3 id="step-1-configuration-of-the-ca-certificate-store">Step 1: Configuration of the CA Certificate Store</h3>
<p>First, deploy template <code>2-4c-mtls-s3</code>. This generates an S3 bucket to store CA certificates.</p>
<p>After this template has been deployed, navigate to S3 and find the bucket that was created. You can check the <strong>Resources</strong> tab in Cloud Formation to find the bucket.</p>
<p>Create an <code>index.yml</code> file that contains the CA store configuration and upload it to the root of the bucket.</p>
<p>The contents of this file are as below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">common</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">common.pem</span><span class="w">
</span></span></span></code></pre></div><p>Create a <code>common</code> folder at the root of this repository. This folder contains the common trusted root certificates that are used to verify the client certificate. In the future, there may be specific groups of trusted root certificates for specific purposes.</p>
<div class="notification is-info is-light has-text-dark">
  <h5 class="title is-family-sans-serif has-text-dark mb-1">Note:</h5>
  If you want to set the certificates later, create an empty <code>index.yml</code> file.
</div>

<h3 id="step-2-fetch-and-store-server-tls-credentials">Step 2: Fetch and Store Server TLS Credentials</h3>
<p>The Things Stack AWS ECS deployment uses Certbot to obtain a TLS server certificate from Let&rsquo;s Encrypt and stores it in AWS Certificate Manager.</p>
<p>As certificates stored in ACM cannot be retrieved, a copy of the TLS server certificate is stored in AWS Secrets Manager. The proxy loads the TLS server certificate from AWS Secrets Manager.</p>
<p>Update <code>4-1-secrets</code> with the following setting:</p>
<ul>
<li>Set <code>SupportProxyTLS</code> set to <code>true</code>.</li>
</ul>
<p>This creates a <code>ProxyTLSSecret</code> for the TLS server certificate secrets and also a <code>GCS token hash key secret</code>, which is used by the Gateway Configuration Server and the Identity Server.</p>
<p>Next, update <code>5-8a-certs-le</code> with the following settings:</p>
<ul>
<li>Set <code> SupportProxyTLS</code> to <code>true</code>. If <code>ExistingCertARN</code> is set, clear this before running the update.</li>
<li>Fetch new certificates by manually requesting it using the <a href="https://www.thethingsindustries.com/docs/enterprise/aws/ecs/deployment/#lets-encrypt-certificates-optional">instructions</a>.</li>
<li>When fetching the certificates, make note of the <code>CertificateArn</code> field from the logs where the new certificates are written.</li>
<li>Once the certificates are successfully queried, rerun the same <code>5-8a-certs-le</code> template but this time set, the <code>ExistingCertARN</code> with the <code>CertificateArn</code> value. This ensures that Certbot renews these certificates and doesn&rsquo;t replace them.</li>
</ul>
<h3 id="step-3-update-the-load-balancer-and-the-proxy">Step 3: Update the Load Balancer and the Proxy</h3>
<p>We now forward traffic from <code>8987</code> on the AWS NLB to <code>8987</code> on Envoy.</p>
<p>First update <code>3-1-security-group-rules</code>. Set <code>LBSCUPSmTLSEnabled</code> to <code>true</code>. This will allow traffic from <code>8987</code> to flow into the cluster.</p>
<p>Next Update <code>3-2-load-balancer-rules</code>.</p>
<ul>
<li>Set <code>SupportProxyTLS</code> to <code>true</code>.</li>
<li>Set <code>TLSCertificateARN</code> with the ARN from the previous step and update.</li>
<li>Set <code>LBSCUPSmTLSEnabled</code> to <code>true</code>.</li>
</ul>
<p>The new certificate is picked up by all TLS listeners and new listener and target group for LoRa Basics™ Station CUPS mTLS is created.</p>
<p>Now, update <code>5-7-ecs-proxy</code>. Set <code>SupportProxyTLS</code> and <code>LBSCUPSmTLSEnabled</code> to <code>true</code>.</p>
<p>Make sure that the image of the proxy is minimum <code>v3.30.0</code>. Images from earlier releases do not contain changes necessary for mTLS support.</p>
<p>You can check if the connection is successful by querying the certificates presented by the <code>8987</code> listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ openssl s_client -connect &lt;domain&gt;:8987
</span></span></code></pre></div><h3 id="step-4-update-the-things-stack-components">Step 4: Update The Things Stack Components</h3>
<p>Since mTLS is supported for LoRa Basics™ Station CUPS , The Things Stack Identity Server and Gateway Configuration Server components require additional configuration.</p>
<p>In <code>4-2a-configuration</code>, set <code>SupportProxyTLS</code> to <code>true</code> and deploy it.</p>
<p>Once that is completed, deploy <code>5-4-ecs-services</code> with <code>SupportProxyTLS</code> set to <code>true</code>.</p>
<h3 id="step-5-testing">Step 5: Testing</h3>
<p>Now that the above setup is complete, we can now test if everything worked. For testing instructions check the <a href="https://www.thethingsindustries.com/docs/hardware/gateways/concepts/lora-basics-station/mtls-authentication/">mTLS Authentication</a> page.</p>
<h2 id="additional-operator-notes">Additional Operator Notes</h2>
<h3 id="reloading-certificates">Reloading Certificates</h3>
<p>Envoy (proxy) supports reloading TLS certificates without dropping active connections.</p>
<p>This is done by using the <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/security/secret#example-three-certificate-rotation-for-xds-grpc-connection">static SDS configuration</a>.</p>
<p>The <code>5-8b-ecs-certbot-scheduled-task</code> runs a periodic task to fetch new server TLS credentials.</p>
<p>If there are new credentials, they will also be stored in Secrets Manager.</p>
<p>The <code>-aws-proxy</code> images used for the proxy contain a cronjob that queries Secrets Manager (daily by default) and updates the proxy configuration.</p>
        </div>
          <div class="columns is-multiline">
</div>

          <div class="is-clearfix">
<a class="button is-pulled-left" href="/docs/enterprise/aws/ecs/interop/">← Interoperability</a>
<a class="button is-pulled-right" href="/docs/enterprise/aws/ecs/troubleshooting/">Troubleshooting AWS ECS Deployment →</a>
</div>

          <script>window.emojicom_widget = { campaign: "NEDHszRC2r2KaGj1mhj7" };</script>
<script src="https://cdn.emojicom.io/embed/widget.js" async></script>

<div class='feedback has-vertical-space'>
  <div id="emojicom-widget-inline"></div>
</div>
        </div>
      </div>
      
      <div class="column is-hidden-touch is-2-desktop sidebar-right">
        <nav class="toc" aria-label="Page navigation">
    <h2 class="title is-size-6">On this page</h2>
    


  <ul class="menu-list">
    
      
      <li><a href='#mechanism'>Mechanism</a></li>
    
      
      <li><a href='#update-instructions'>Update Instructions</a></li>
    
      
      <li><a href='#additional-operator-notes'>Additional Operator Notes</a></li>
    
  </ul>


  </nav>

      </div>
      
  </div>
</div>



<footer class="footer">
  <div class="container">
    <div class="columns">
      <nav class="column is-one-third">
        <h3 class="title is-6">The Things Stack</h3>
        <p><a class="" href="/docs/getting-started/">Getting Started</a></p>
        <p><a class="" href="/docs/concepts/">Concepts</a></p>
        <p><a class="" href="/docs/cloud/">The Things Stack Cloud</a></p>
        <p><a class="" href="/docs/enterprise/">The Things Stack Enterprise</a></p>
        <p><a class="" href="/docs/integrations/">Integrations</a></p>
        <p><a class="" href="/docs/api/">API</a></p>
        <p><a class="" href="/docs/hardware/">Hardware</a></p>
      </nav>
      <nav class="column is-one-third">
        <h3 class="title is-6">Contributing</h3>
        <p><a class="" href="https://github.com/TheThingsIndustries/lorawan-stack-docs">GitHub</a></p>
      </nav>
      
      <nav class="column is-one-third">
        <h3 class="title is-6">About Us</h3>
        <p><a class="" href="https://www.thethingsindustries.com">The Things Industries</a></p>
      </nav>
      </div>
  </div>
</footer>
<script src="https://www.thethingsindustries.com/docs/js/vendor/basicLightbox.min.js"></script>
<script src="https://www.thethingsindustries.com/docs/js/theme.min.3bf0da17f5ab4cc0f916662c2d2f977f7fa7259b4483f7f9eb46e875a556cc43.js" integrity="sha256-O/DaF/WrTMD5FmYsLS&#43;Xf3&#43;nJZtEg/f560bodaVWzEM=" crossorigin="anonymous"></script><script>
  window.intercomSettings = {
    app_id: "pp8esr7h",
  };
</script>

<script>
(function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/pp8esr7h';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
</script>

</body>

</html>
