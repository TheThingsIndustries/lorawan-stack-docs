<!DOCTYPE html>

<html class="has-navbar-fixed-top">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="generator" content="Hugo 0.96.0" />
  <title>Adaptive Data Rate | The Things Stack for LoRaWAN</title><link rel="canonical" href="https://www.thethingsindustries.com/docs/reference/adr/" />
  <link rel="alternate icon" type="image/png" href="/docs/favicon.png">
  <link rel="icon" type="image/svg+xml" href="/docs/favicon.svg">
  <link rel="stylesheet" href="https://www.thethingsindustries.com/docs/css/theme.min.8afd1a9ba4c2f5b2a5910c50125ba2636f89937b2e7f5ca55766ed500a2a1e4f.css" integrity="sha256-iv0am6TC9bKlkQxQEluiY2&#43;Jk3suf1ylV2btUAoqHk8=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta itemprop="name" content="Adaptive Data Rate">
  <meta itemprop="description" content="">
  <meta itemprop="keywords" content="">
  <meta property="og:title" content="Adaptive Data Rate">
  <meta property="og:description" content="">
  <meta property="og:url" content="https://www.thethingsindustries.com/docs/reference/adr/">
  <meta name="twitter:title" content="Adaptive Data Rate" />
  <meta name="twitter:description" content="" />
  <meta name="twitter:card" content="summary" />
</head>


<body><nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
  <div class="container is-fluid">
    <div class="navbar-brand">
      <a class="navbar-item" href="/docs/">
        <img class="logo" src="/docs/img/TTS-logo.svg">
        <p class="navbar-item is-size-7">v3.24.0</p>
      </a><div class="navbar-item navbar-search-menu" id="search-input-menu">
          </div>
      <span class="navbar-burger burger" data-target="topMenu">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </div>
    <div id="topMenu" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item" href="/docs/getting-started/">Getting Started</a>
        <a class="navbar-item" href="/docs/devices/">Devices</a>
        <a class="navbar-item" href="/docs/gateways/">Gateways</a>
        <a class="navbar-item" href="/docs/integrations/">Integrations</a>
        <a class="navbar-item" href="/docs/reference/">Reference</a>

      </div>
      <div class="navbar-end"><div class="navbar-item">
            <a class="button is-primary" href="https://accounts.thethingsindustries.com/fee-calculator">Get The Things Stack</a>
          </div>
      </div>
    </div>
  </div>
</nav><script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
  <script type="text/javascript">
    docsearch({
      appId: "608OILUBK2",
      apiKey: "39082cdce449b93b2aa806b44f6af4d2",
      indexName: "thethingsstack",
      container: '#search-input-menu',
      debug: false, 
    });
  </script><div class="container" role="document">
  <div class="columns my-0 ">
      
      <div class="column is-3 is-2-desktop sidebar-left">
        

<nav class="side-navigation" aria-label="Main navigation">

<h2 class="title is-size-5">Reference</h2>

<ul class="menu-list">
<a href="https://www.thethingsindustries.com/docs/reference/" class="">Overview</a>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/adr/" class="is-active">Adaptive Data Rate</a>
    



    
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/api/" class="">API</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/application-packages/" class="">Application Packages</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/stripe/" class="">Billing with Stripe</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/cli/" class="">Command-Line Interface</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/components/" class="">Components</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/configuration/" class="">Configuration</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/data-formats/" class="">Data Formats</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/data-retention/" class="">Data Retention and Privacy</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/device-claiming-repository/" class="">Device Claiming Configuration</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/email-templates/" class="">Email Templates</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/federated-auth/" class="">Federated Authentication</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/frequency-plans/" class="">Frequency Plans</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/fuota/" class="">FUOTA</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/gateway-rtt/" class="">Gateway RTT</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/glossary/" class="">Glossary</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/id-eui-constraints/" class="">ID and EUI Constraints</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/last-activity/" class="">Last Activity</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/lbs-implementation-guide/implementation-details/" class="">LoRa Basics Station Implementation Guide</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/interop-repository/" class="">LoRaWAN Join Server Configuration</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/spec-regional-parameters/" class="">LoRaWAN Specification and Regional Parameters</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/networking/" class="">Networking</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/pb-routing/" class="">Packet Broker Routing</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/packet-forwarder/" class="">Packet Forwarders</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/purge/" class="">Purging Entities</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/rate-limiting/" class="">Rate Limiting</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/resource-limiting/" class="">Resource Limiting</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/root-certificates/" class="">Root Certificates</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/telemetry/" class="">Telemetry</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/tenant-management/" class="">Tenant Management</a>
  </li>
<li>
    <a href="https://www.thethingsindustries.com/docs/reference/branding/" class="">Web UI Branding</a>
  </li>
</ul>



</nav>








      </div>
      
      <div class="column is-9 is-8-desktop sidebar-middle">
        <div class="docs-content">
        <h1 class="title is-size-2">Adaptive Data Rate
          
        </h1>
        
        <div class="content">
          <p>Adaptive Data Rate (ADR) is a mechanism for optimizing data rates, airtime and energy consumption in the network.</p>
<p>This reference documents how ADR is implemented in The Things Stack.</p>
<h2 id="how-adr-works">How ADR Works</h2>
<p>The ADR mechanism controls the following transmission parameters of an end device:</p>
<ul>
<li>Spreading factor</li>
<li>Bandwidth</li>
<li>Transmission power</li>
</ul>
<p>See <a href="https://www.thethingsnetwork.org/docs/lorawan/adaptive-data-rate/">The Things Network LoRaWAN documentation</a> for a general description of ADR. See the <a href="https://www.thethingsnetwork.org/docs/lorawan/spreading-factors/">Spreading Factors</a> section to learn how spreading factor influences data rate, range and battery life.</p>
<h2 id="the-things-stack-adr-algorithm">The Things Stack ADR Algorithm</h2>
<p>This section describes The Things Stack ADR implementation in plain english, with links to the relevant lines of source code in our open source <a href="https://github.com/TheThingsNetwork/lorawan-stack">LoRaWAN Stack Repository</a>.</p>
<p>The Things Stack ADR implementation looks at the signal-to-noise ratio (SNR) to determine the Data Rate and Tx Power, and looks at frame counters to determine packet loss, and set the number of re-transmissions accordingly.</p>
<p>The implementation is based on Semtech&rsquo;s recommended algorithm described in <a href="https://www.thethingsnetwork.org/forum/uploads/default/original/2X/7/7480e044aa93a54a910dab8ef0adfb5f515d14a1.pdf">this document</a>:</p>
<ol>
<li>Determine <a href="https://github.com/TheThingsNetwork/lorawan-stack/blob/5a816e8171f993db9659566286d45725698f032e/pkg/networkserver/mac/adr.go#L218">the maximum SNR over recent transmissions</a></li>
<li>Determine <a href="https://github.com/TheThingsNetwork/lorawan-stack/blob/5a816e8171f993db9659566286d45725698f032e/pkg/networkserver/mac/adr.go#L232">the minimum SNR to demodulate an uplink given the current parameters</a></li>
<li>Calculate <a href="https://github.com/TheThingsNetwork/lorawan-stack/blob/5a816e8171f993db9659566286d45725698f032e/pkg/networkserver/mac/adr.go#L236">the margin to further optimize the data rate</a></li>
</ol>
<ul>
<li>Part of this is configurable per device (if you use the CLI)</li>
<li>If less measurements (uplinks) are available than necessary, <a href="https://github.com/TheThingsNetwork/lorawan-stack/blob/5a816e8171f993db9659566286d45725698f032e/pkg/networkserver/mac/adr.go#L238-L240">include a safety margin</a></li>
</ul>
<ol start="4">
<li><a href="https://github.com/TheThingsNetwork/lorawan-stack/blob/5a816e8171f993db9659566286d45725698f032e/pkg/networkserver/mac/adr.go#L251-L262">Increase the data rate as long as there&rsquo;s enough margin</a></li>
<li>If there&rsquo;s still margin after reaching the maximum data rate, <a href="https://github.com/TheThingsNetwork/lorawan-stack/blob/5a816e8171f993db9659566286d45725698f032e/pkg/networkserver/mac/adr.go#L273-L281">decrease the transmit power</a></li>
<li>Depending on packet loss, <a href="https://github.com/TheThingsNetwork/lorawan-stack/blob/5a816e8171f993db9659566286d45725698f032e/pkg/networkserver/mac/adr.go#L288-L296">increase the number of retransmissions</a></li>
</ol>
<h2 id="custom-adr-algorithm">Custom ADR Algorithm</h2>
<p>Besides The Things Stack ADR mechanism described <a href="https://www.thethingsindustries.com/docs/reference/adr/#the-things-stack-adr-algorithm">above</a>, The Things Stack also supports using a custom ADR, meaning ADR parameters (data rate, Tx power, number of transmissions per uplink frame) can be controlled manually.</p>
<div class="notification is-info is-light has-text-dark">
  <h5 class="title is-family-sans-serif has-text-dark mb-1">Note:</h5>
  We recommend to test the process described below on test devices before implementing it in production.
</div>

<p>Before setting ADR parameters to desired values, you first need to turn off the default, The Things Stack ADR mechanism. To turn of The Things Stack ADR using the <a href="https://www.thethingsindustries.com/docs/getting-started/cli/">CLI</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ttn-lw-cli end-devices <span class="nb">set</span> --application-id &lt;app-id&gt; --device-id &lt;dev-id&gt; --mac-settings.use-adr<span class="o">=</span><span class="nb">false</span>
</span></span></code></pre></div><p>After The Things Stack ADR mechanism is disabled, the Network Server will no longer try to optimize ADR parameters.</p>
<p>Now you can manually set ADR parameters to desired values using the CLI:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ttn-lw-cli end-devices <span class="nb">set</span> --application-id &lt;app-id&gt; --device-id &lt;dev-id&gt; --mac-state.desired-parameters.adr-data-rate-index &lt;data_rate&gt; --mac-state.desired-parameters.adr-tx-power-index &lt;power_index&gt; --mac-state.desired-parameters.adr-nb-trans &lt;nb_trans&gt;
</span></span></code></pre></div><p>Desired values that you set for ADR parameters need to be supported by the end device based on its MAC and PHY versions, and its frequency plan. Upon receiving a next uplink message, the Network Server schedules a <code>LinkADRReq</code> message with new ADR parameters included.</p>
<p>If the end device accepts all three parameters specified, then it will use them and answer with a <code>LinkADRAns</code> uplink message. We recommend setting all three parameters explicitly to avoid a possible rejection.</p>
<p>Keep in mind that changes to <code>mac-state.desired-parameters.&lt;parameter&gt;</code> are not persistent and will be lost on a device reset/rejoin. Read the <a href="https://www.thethingsindustries.com/docs/devices/mac-settings/">MAC Settings</a> section for detailed info.</p>
<h2 id="configuring-adr-margin">Configuring ADR Margin</h2>
<p>The Things Stack Network Server calculates the ADR margin to optimize the data rate and Tx power.</p>
<p>Margin is the difference between the gateway&rsquo;s maximum measured SNR and the minimal SNR required to demodulate a message on a given data rate. Margin is used to determine how much data rate can be increased, or how much transmit power can be lowered. Increasing the ADR margin reduces the data rate, leading to a reduced overall network capacity, but also to a lower packet loss rate in lightly loaded networks. Decreasing the ADR margin leads to a data rate increase, network capacity enhancement, but also causes higher packet loss rate.</p>
<div class="notification is-info is-light has-text-dark">
  <h5 class="title is-family-sans-serif has-text-dark mb-1">Note:</h5>
  We recommend to test the process described below on test devices before implementing it in production. It is also recommended to use different test scenarios to identify which margin best fits your environment.
</div>

<p>The Network Server uses the ADR margin of 15, but this value can be configured per device using the CLI:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ttn-lw-cli end-devices <span class="nb">set</span> --application-id &lt;app-id&gt; --device-id &lt;device-id&gt; --mac-settings.adr-margin &lt;float32&gt;
</span></span></code></pre></div><p>Keep in mind that changes to <code>mac-settings.&lt;parameter&gt;</code> are persistent and will be present even after a device reset/rejoin. Read the <a href="https://www.thethingsindustries.com/docs/devices/mac-settings/">MAC Settings</a> section for detailed info.</p>
<h3 id="examples">Examples</h3>
<p>Consider a device whose SNR values in the last 20 uplink messages were in range from 0 to 7. The data rate of the last received frame from the end device is DR3. Three cases presented below demonstrate how choosing a different ADR margin leads to different outcomes in terms of changing the data rate and Tx power.</p>
<p>In practice, the ADR margin value should be tuned until the optimization target is reached. The optimization target can be different (like battery duration, low packet loss, etc.) in different environments, so a user needs to decide on which margin value to adopt.</p>
<h4 id="case-1-adr-margin-set-to-default">Case 1: ADR margin set to default</h4>
<p>The default ADR margin value in The Things Stack is 15, while the minimum SNR required to demodulate a message for DR3 is 12.5.</p>
<p>First, the maximum SNR is computed for recent uplinks. In this example, the <code>SNRmax</code> is 7.</p>
<p>Then the SNR margin is calculated as follows:</p>
<p>SNR<sub>margin</sub> = SNR<sub>max</sub> - SNR<sub>DR3</sub> - margin<sub>dB</sub> = 7-(-12.5)-15 = 4.5</p>
<p>The final step is to calculate the <code>NStep</code> value to decide whether a data rate can be optimized:</p>
<p>NStep=int(SNR<sub>margin</sub>/2.5) = int (4.5/2.5) = 1</p>
<p>Considering the diagram for acting on an NStep calculation depicted <a href="https://www.thethingsnetwork.org/forum/uploads/default/original/2X/7/7480e044aa93a54a910dab8ef0adfb5f515d14a1.pdf">here</a>, the conclusion for this example is that the Network Server should increase the data rate to DR4.</p>
<h4 id="case-2-adr-margin-set-to-18">Case 2: ADR margin set to 18</h4>
<p>The SNR margin would be:</p>
<p>SNR<sub>margin</sub> = SNR<sub>max</sub> - SNR<sub>DR3</sub> - margin<sub>dB</sub> = 7-(-12.5)-18 = 1.5</p>
<p>The <code>NStep</code> value would be:</p>
<p>NStep=int(SNR<sub>margin</sub>/2.5) = int (1.5/2.5) = 0</p>
<p>In this case, according to the previously mentioned <a href="https://www.thethingsnetwork.org/forum/uploads/default/original/2X/7/7480e044aa93a54a910dab8ef0adfb5f515d14a1.pdf">diagram</a>, the Network Server should not take any action to further optimize the data rate.</p>
<h4 id="case-3-adr-margin-set-to-25">Case 3: ADR margin set to 25</h4>
<p>The SNR margin would be:</p>
<p>SNR<sub>margin</sub> = SNR<sub>max</sub> - SNR<sub>DR3</sub> - margin<sub>dB</sub> = 7-(-12.5)-25 = -5.5</p>
<p>The <code>NStep</code> value would be:</p>
<p>NStep=int(SNR<sub>margin</sub>/2.5) = int (-5.5/2.5) = -1</p>
<p>In this case, according to the previously mentioned <a href="https://www.thethingsnetwork.org/forum/uploads/default/original/2X/7/7480e044aa93a54a910dab8ef0adfb5f515d14a1.pdf">diagram</a>, if Tx power is lower than its maximum, the Network Server should increase it once by 3dB, while the data rate should not be changed.</p>
        </div>
        
          <div class="is-clearfix">
<a class="button is-pulled-left" href="/docs/reference/">← Reference</a>
<a class="button is-pulled-right" href="/docs/reference/api/">API →</a>
</div>

          <script>window.emojicom_widget = { campaign: "NEDHszRC2r2KaGj1mhj7" };</script>
<script src="https://cdn.emojicom.io/embed/widget.js" async></script>

<div class='feedback has-vertical-space'>
  <div id="emojicom-widget-inline"></div>
</div>
        </div>
      </div>
      
      <div class="column is-hidden-touch is-2-desktop sidebar-right">
        <nav class="toc" aria-label="Page navigation">
    <h2 class="title is-size-6">On this page</h2>
    


  <ul class="menu-list">
    
      
      <li><a href='#how-adr-works'>How ADR Works</a></li>
    
      
      <li><a href='#the-things-stack-adr-algorithm'>The Things Stack ADR Algorithm</a></li>
    
      
      <li><a href='#custom-adr-algorithm'>Custom ADR Algorithm</a></li>
    
      
      <li><a href='#configuring-adr-margin'>Configuring ADR Margin</a></li>
    
  </ul>


  </nav>

      </div>
      
  </div>
</div>



<footer class="footer">
  <div class="container">
    <div class="columns">
      <nav class="column is-one-quarter">
        <h3 class="title is-6">The Things Stack</h3>
        <p><a class="" href="/docs/getting-started/">Getting Started</a></p>
        <p><a class="" href="/docs/devices/">Devices</a></p>
        <p><a class="" href="/docs/gateways/">Gateways</a></p>
        <p><a class="" href="/docs/integrations/">Integrations</a></p>
        <p><a class="" href="/docs/reference/">Reference</a></p>
      </nav>
      <nav class="column is-one-quarter">
        <h3 class="title is-6">Contributing</h3>
        <p><a class="" href="https://github.com/TheThingsIndustries/lorawan-stack-docs">GitHub</a></p>
        <p><a class="" href="https://www.thethingsnetwork.org/forum/c/ttn-network/v3/90">Forum</a></p>
      </nav>
      
      <nav class="column is-one-quarter">
        <h3 class="title is-6">About Us</h3>
        <p><a class="" href="https://www.thethingsnetwork.org">The Things Network</a></p>
        <p><a class="" href="https://www.thethingsindustries.com">The Things Industries</a></p>
      </nav>
      <div class="column is-one-quarter">
        <h3 class="title is-6">About this page</h3>
        <div class="content">
<p class="is-size-7">
  Last changed by Nejra Selimović on 04 Mar 2022.
  <br>
  <a href="https://github.com/TheThingsIndustries/lorawan-stack-docs/commit/afbe9d9b92fa6cb11cf056be316dddc56382e0a5">
      doc: Document setting custom ADR params (#798)
    </a>
</p>

<a href="https://github.com/TheThingsIndustries/lorawan-stack-docs/blob/master/doc/content/reference/adr/_index.md" class="button">Edit on Github</a>
</div>

      </div>
    </div>
  </div>
</footer>
<script src="https://www.thethingsindustries.com/docs/js/vendor/basicLightbox.min.js"></script>
<script src="https://www.thethingsindustries.com/docs/js/theme.min.a32708c8796e7e8713fa926212adddbbf5c15cdd97676d898ecfc17bc6d9ed4f.js" integrity="sha256-oycIyHlufocT&#43;pJiEq3du/XBXN2XZ22Jjs/Be8bZ7U8=" crossorigin="anonymous"></script><script>
  window.intercomSettings = {
    app_id: "pp8esr7h",
  };
</script>

<script>
(function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/pp8esr7h';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
</script>

</body>

</html>
